<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vcampus.server.core.library.mapper.BookBorrowMapper">
    
    <!-- 结果映射 -->
    <resultMap id="BookBorrowResultMap" type="com.vcampus.server.core.library.entity.BookBorrow">
        <id column="trans_Id" property="transId"/>
        <result column="book_Id" property="bookId"/>
        <result column="cardNum" property="cardNum"/>
        <result column="Borrow_time" property="borrowTime"/>
        <result column="Return_time" property="returnTime"/>
        <result column="Due_time" property="dueTime"/>
        <result column="Status" property="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="Renew_count" property="renewCount"/>
        <result column="Remarks" property="remarks"/>
    </resultMap>
    
    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        trans_Id, book_Id, cardNum, Borrow_time, Return_time, Due_time, Status, Renew_count, Remarks
    </sql>
    
    <!-- 根据ID查询 -->
    <select id="findById" parameterType="int" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE trans_Id = #{transId}
    </select>
    
    <!-- 查询所有借阅记录 -->
    <select id="findAll" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        ORDER BY Borrow_time DESC
    </select>
    
    <!-- 根据用户卡号查询 -->
    <select id="findByCardNum" parameterType="string" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE cardNum = #{cardNum}
        ORDER BY Borrow_time DESC
    </select>
    
    <!-- 根据图书ID查询 -->
    <select id="findByBookId" parameterType="int" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE book_Id = #{bookId}
        ORDER BY Borrow_time DESC
    </select>
    
    <!-- 查询用户当前借阅中的图书 -->
    <select id="findCurrentBorrowsByCardNum" parameterType="string" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE cardNum = #{cardNum} AND Status = 'BORROWED'
        ORDER BY Due_time ASC
    </select>
    
    <!-- 查询用户已归还的图书 -->
    <select id="findReturnedBorrowsByCardNum" parameterType="string" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE cardNum = #{cardNum} AND Status = 'RETURNED'
        ORDER BY Return_time DESC
    </select>
    
    <!-- 查询用户逾期的图书 -->
    <select id="findOverdueBorrowsByCardNum" parameterType="string" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE cardNum = #{cardNum} AND Status = 'OVERDUE'
        ORDER BY Due_time ASC
    </select>
    
    <!-- 查询所有逾期的借阅记录 -->
    <select id="findAllOverdueBorrows" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE Status = 'OVERDUE'
        ORDER BY Due_time ASC
    </select>
    
    <!-- 查询图书当前借阅中的记录 -->
    <select id="findCurrentBorrowsByBookId" parameterType="int" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE book_Id = #{bookId} AND Status = 'BORROWED'
        ORDER BY Borrow_time ASC
    </select>
    
    <!-- 查询图书的借阅历史 -->
    <select id="findBorrowHistoryByBookId" parameterType="int" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        WHERE book_Id = #{bookId}
        ORDER BY Borrow_time DESC
    </select>
    
    <!-- 查询最近借阅记录 -->
    <select id="findRecentBorrows" parameterType="int" resultMap="BookBorrowResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tblBook_trans
        ORDER BY Borrow_time DESC
        LIMIT #{limit}
    </select>
    
    <!-- 插入借阅记录 -->
    <insert id="insert" parameterType="com.vcampus.server.core.library.entity.BookBorrow" useGeneratedKeys="true" keyProperty="transId">
        INSERT INTO tblBook_trans (book_Id, cardNum, Borrow_time, Return_time, Due_time, Status, Renew_count, Remarks)
        VALUES (#{bookId}, #{cardNum}, #{borrowTime}, #{returnTime}, #{dueTime}, #{status}, #{renewCount}, #{remarks})
    </insert>
    
    <!-- 更新借阅记录 -->
    <update id="update" parameterType="com.vcampus.server.core.library.entity.BookBorrow">
        UPDATE tblBook_trans
        SET book_Id = #{bookId},
            cardNum = #{cardNum},
            Borrow_time = #{borrowTime},
            Return_time = #{returnTime},
            Due_time = #{dueTime},
            Status = #{status},
            Renew_count = #{renewCount},
            Remarks = #{remarks}
        WHERE trans_Id = #{transId}
    </update>
    
    <!-- 根据ID删除 -->
    <delete id="deleteById" parameterType="int">
        DELETE FROM tblBook_trans WHERE trans_Id = #{transId}
    </delete>
    
    <!-- 检查是否存在 -->
    <select id="existsById" parameterType="int" resultType="boolean">
        SELECT COUNT(1) > 0 FROM tblBook_trans WHERE trans_Id = #{transId}
    </select>
    
    <!-- 统计数量 -->
    <select id="count" resultType="long">
        SELECT COUNT(1) FROM tblBook_trans
    </select>
    
    <!-- 统计用户借阅数量 -->
    <select id="countBorrowsByCardNum" parameterType="string" resultType="long">
        SELECT COUNT(1) FROM tblBook_trans WHERE cardNum = #{cardNum}
    </select>
    
    <!-- 统计用户当前借阅数量 -->
    <select id="countCurrentBorrowsByCardNum" parameterType="string" resultType="long">
        SELECT COUNT(1) FROM tblBook_trans WHERE cardNum = #{cardNum} AND Status = 'BORROWED'
    </select>
    
    <!-- 统计图书借阅次数 -->
    <select id="countBorrowsByBookId" parameterType="int" resultType="long">
        SELECT COUNT(1) FROM tblBook_trans WHERE book_Id = #{bookId}
    </select>
    
    <!-- 检查用户是否已借阅某本图书 -->
    <select id="isBookBorrowedByUser" resultType="boolean">
        SELECT COUNT(1) > 0 FROM tblBook_trans 
        WHERE book_Id = #{bookId} AND cardNum = #{cardNum} AND Status = 'BORROWED'
    </select>
    
    <!-- 更新借阅记录状态 -->
    <update id="updateStatus">
        UPDATE tblBook_trans SET Status = #{status} WHERE trans_Id = #{transId}
    </update>
    
    <!-- 更新归还时间 -->
    <update id="updateReturnTime">
        UPDATE tblBook_trans SET Return_time = #{returnTime} WHERE trans_Id = #{transId}
    </update>
    
    <!-- 更新续借信息 -->
    <update id="updateRenewInfo">
        UPDATE tblBook_trans 
        SET Due_time = #{newDueTime}, Renew_count = #{newRenewCount} 
        WHERE trans_Id = #{transId}
    </update>
    
</mapper>
